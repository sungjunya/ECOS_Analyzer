<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <title>ECOS 대시보드</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f9fafb;
        }

        h1 {
            text-align: center;
            color: #1f2937;
        }

        .tabs {
            text-align: center;
            margin: 20px 0;
        }

        .tab-btn {
            padding: 10px 20px;
            margin: 0 5px;
            font-size: 16px;
            background: #e5e7eb;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab-btn.active {
            background: #3b82f6;
            color: white;
        }

        .summary {
            text-align: center;
            font-size: 1.1em;
            color: #374151;
            margin-bottom: 16px;
        }

        /* ✅ 통합 경제 요약 박스 */
        #overall-summary {
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 12px;
            padding: 16px;
            margin: 10px 0 20px 0;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
            line-height: 1.6;
            color: #111827;
            font-size: 0.95em;
            font-weight: 500;
        }

        .chart-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .chart-box {
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .chart-box h3 {
            margin: 0 0 8px;
            font-size: 1.1em;
            color: #111827;
        }

        .info {
            margin-top: 8px;
            font-weight: 600;
            color: #111827;
        }

        .desc {
            margin-top: 6px;
            color: #4b5563;
            line-height: 1.45;
            font-size: 0.95em;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            color: white;
            margin-left: 8px;
        }

        .badge.green {
            background: #10b981;
        }

        .badge.yellow {
            background: #f59e0b;
        }

        .badge.orange {
            background: #f97316;
        }

        .badge.red {
            background: #ef4444;
        }

        .badge.gray {
            background: #6b7280;
        }
    </style>
</head>

<body>
    <h1>경제 지표 투자 신호 대시보드</h1>

    <div class="tabs">
        <button class="tab-btn active" onclick="setPeriod(event, '1y')">1년</button>
        <button class="tab-btn" onclick="setPeriod(event, '3y')">3년</button>
        <button class="tab-btn" onclick="setPeriod(event, '5y')">5년</button>
    </div>

    <div class="summary" id="summary">로딩 중...</div>

    <!-- ✅ 통합 경제 요약 박스 -->
    <div id="overall-summary">전체 경제 요약 로딩 중...</div>

    <div class="chart-container">
        <div class="chart-box">
            <h3>장단기 금리 스프레드</h3>
            <canvas id="chart-spread"></canvas>
            <div class="info" id="spread-info"></div>
            <div class="desc" id="spread-desc"></div>
        </div>

        <div class="chart-box">
            <h3>M2 증가율 (YoY)</h3>
            <canvas id="chart-m2"></canvas>
            <div class="info" id="m2-info"></div>
            <div class="desc" id="m2-desc"></div>
        </div>

        <div class="chart-box">
            <h3>CPI 증가율 (YoY)</h3>
            <canvas id="chart-cpi"></canvas>
            <div class="info" id="cpi-info"></div>
            <div class="desc" id="cpi-desc"></div>
        </div>

        <div class="chart-box">
            <h3>PPI 증가율 (YoY)</h3>
            <canvas id="chart-ppi"></canvas>
            <div class="info" id="ppi-info"></div>
            <div class="desc" id="ppi-desc"></div>
        </div>
    </div>

    <script>
        let currentPeriod = '1y';
        const charts = {};

        function setPeriod(ev, period) {
            currentPeriod = period;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            ev.target.classList.add('active');
            loadData();
        }

        function loadData() {
            document.getElementById('summary').innerText = '데이터 로딩 중...';
            document.getElementById('overall-summary').innerText = '전체 경제 요약 로딩 중...';

            fetch(`/api/signal?period=${currentPeriod}`)
                .then(r => r.json())
                .then(data => {
                    const ym = `${data.date.slice(0, 4)}년 ${data.date.slice(4)}월`;
                    const summaryText = `기준일: ${ym} · 기간: ${data.period} · ${data.classification?.level || ''}`;
                    document.getElementById('summary').innerText = summaryText;

                    // ✅ 상단 경제 요약 표시
                    document.getElementById('overall-summary').innerText = data.summary || '요약 데이터 없음';

                    // ✅ 각 지표별 차트 업데이트
                    updateChart('spread', data.indicators.spread);
                    updateChart('m2', data.indicators.m2);
                    updateChart('cpi', data.indicators.cpi);
                    updateChart('ppi', data.indicators.ppi);
                })
                .catch(err => {
                    document.getElementById('summary').innerHTML = `<span style="color:red;">에러: ${err.message}</span>`;
                    document.getElementById('overall-summary').innerHTML = `<span style="color:red;">요약 불러오기 실패</span>`;
                });
        }

        function updateChart(key, info) {
            const canvas = document.getElementById(`chart-${key}`);
            const ctx = canvas.getContext('2d');
            const infoEl = document.getElementById(`${key}-info`);
            const descEl = document.getElementById(`${key}-desc`);

            // ✅ 추세에 따른 색상 결정
            const trend = info.trend || '큰 변화 없음';
            const color =
                trend === '상승세' ? '#ef4444' : // 빨강
                    trend === '하락세' ? '#3b82f6' : // 파랑
                        '#6b7280'; // 회색

            // 정보 표시
            infoEl.innerHTML = `
        평균: <strong>${isNaN(info.latest) ? 'N/A' : info.latest + '%'}</strong>
        <span style="margin-left:8px;color:#6b7280;">추세: ${trend}</span>
      `;
            descEl.textContent = info.description || '';

            // 기존 차트 삭제
            if (charts[key]) charts[key].destroy();

            // 새 차트 생성
            const labels = info.chartData.map(d => d.time.slice(0, 4) + '.' + d.time.slice(4));
            const values = info.chartData.map(d => (d.value === 'N/A' ? null : d.value));

            charts[key] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: key.toUpperCase(),
                        data: values,
                        borderColor: color,
                        backgroundColor: 'transparent',
                        tension: 0.3,
                        pointRadius: 3,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: ctx => ctx.parsed.y === null ? 'N/A' :
                                    (key === 'spread' ? ctx.parsed.y.toFixed(2) + 'pp' : ctx.parsed.y.toFixed(2) + '%')
                            }
                        }
                    },
                    scales: { y: { beginAtZero: false } }
                }
            });
        }

        loadData();
    </script>
</body>

</html>